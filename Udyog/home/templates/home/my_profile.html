{%load static %}

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>My Profile ‚Ä¢ Udyog Refer</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'] },
          colors: {
            ur: { blue: '#2563eb', blue600: '#2563eb', blue700: '#1d4ed8', blue800: '#1e40af' }
          },
          boxShadow: {
            soft: '0 3px 14px rgba(0,0,0,.06)',
            card: '0 8px 30px rgba(37,99,235,.08)'
          },
          borderRadius: { xl2: '1.25rem' }
        }
      }
    }
  </script>
  <style>
@keyframes paPulse {
  0%   { box-shadow: 0 0 0 0 rgba(59,130,246,.45); }
  70%  { box-shadow: 0 0 0 10px rgba(59,130,246,0); }
  100% { box-shadow: 0 0 0 0 rgba(59,130,246,0); }
}
.pa-glow {
  animation: paPulse 2s infinite;
}
</style>

  <style>
    /* Small helper so disabled things feel disabled */
    .is-disabled { pointer-events: none; opacity: .55; }
  </style>
</head>

<body class="bg-gray-100 font-sans text-[15px] text-gray-800 antialiased">
  <!-- ===== App Shell ===== -->
  <div class="flex min-h-screen">

    <!-- ========= Left Sidebar (fixed) ========= -->
   <aside class="w-20 bg-gradient-to-b from-blue-800 via-blue-900 to-slate-900 text-white flex flex-col items-center py-6 fixed top-0 bottom-0">
               <!-- UR Logo -->
               <a href="/" class="mb-10">
               <img src="{% static 'img/ur_logo.ico' %}" alt="Udyog Refer Logo"
                  class="w-10 h-10 rounded-lg shadow-md hover:scale-105 transition-transform" />
               </a>
               <!-- Vertically centered wrapper -->
               <div class="flex-1 flex flex-col justify-center space-y-6">
                  <!-- Refere -->
                  <a href="{% url 'referer_home' %}" class="group relative">
                     <div class="p-3 rounded-full bg-gray-800  ">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                           <path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14c-4 0-8 2-8 4v2h16v-2c0-2-4-4-8-4z" />
                        </svg>
                     </div>
                     <span class="absolute top-12 left-1/2 -translate-x-1/2 text-xs px-2 py-1 bg-gray-800 text-white rounded opacity-0 group-hover:opacity-100 whitespace-nowrap z-10">Post Refers</span>
                  </a>
                  <!-- My Earnings -->
                  <a href="#" onclick="openEarningsModal()" class="group relative">
                     <div class="p-3 rounded-full hover:bg-gray-700 ring-1 transition-all">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                           stroke-width="1.5" stroke="currentColor" class="w-6 h-6 text-white">
                           <path stroke-linecap="round" stroke-linejoin="round"
                              d="M15 8.25H9m6 3H9m3 6-3-3h1.5a3 3 0 1 0 0-6M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"/>
                        </svg>
                     </div>
                     <span class="absolute top-12 left-1/2 -translate-x-1/2 text-xs px-2 py-1
                        bg-gray-800 text-white rounded opacity-0 group-hover:opacity-100 whitespace-nowrap z-10">
                     My Earnings
                     </span>
                  </a>
                  <!--Tracker-->
                   <a href="{% url 'my_tracker' %}" class="relative group">
            <div class="p-3 rounded-full hover:bg-gray-700 transition-all">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
  <path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 0 1 3 19.875v-6.75ZM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V8.625ZM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V4.125Z" />
</svg>

            </div>
          </a>


               </div>
            </aside>

    <!-- ========= Main Column ========= -->
    <div class="flex-1 ml-20 flex flex-col">

      <!-- Top Bar -->
   <header class="sticky top-0 z-10 bg-white/20 backdrop-blur-sm border-b border-gray-200 flex justify-between items-center px-6 py-4 shadow">
          <h1 class="text-2xl font-bold">Profile</h1>

          <div class="flex items-center gap-6">

            <!-- Right: Personal Assist (glow) + Settings + Logout -->
          <div class="justify-self-end flex items-center gap-3">




            <!-- Personal Assist trigger -->
            <button type="button" onclick="openPAModal()" aria-label="Open Personal Assist"
                    class="relative p-2 rounded hover:bg-gray-200 focus:outline-none focus-visible:ring-2 focus-visible:ring-blue-500">
              <span class="absolute inset-0 rounded-full pa-glow pointer-events-none"></span>
              <svg class="relative w-6 h-6 text-gray-700" viewBox="0 0 24 24" fill="none"
                   stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round"
                      d="M12 6v.01M16.24 7.76v.01M18 12v.01M16.24 16.24v.01M12 18v.01M7.76 16.24v.01M6 12v.01M7.76 7.76v.01" />
                <circle cx="12" cy="12" r="3" />
              </svg>
            </button>
             <!-- User Profile Icon and Trigger button -->
          <div class="relative">
          <button onclick="toggleProfileModal()"
                  class="p-2 rounded hover:bg-gray-200 focus:outline-none"
                  aria-label="User Profile">
            <svg xmlns="http://www.w3.org/2000/svg" 
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="1.5"
                class="w-6 h-6 text-gray-700">
              <path stroke-linecap="round" stroke-linejoin="round"
                    d="M17.982 18.725A7.488 7.488 0 0 0 12 15.75a7.488 7.488 0 0 0-5.982 2.975m11.963 0a9 9 0 1 0-11.963 0m11.963 0A8.966 8.966 0 0 1 12 21a8.966 8.966 0 0 1-5.982-2.275M15 9.75a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
            </svg>
          </button>

          <!-- Profile Modal -->
          <div id="profileModal"
              class="hidden absolute right-0 mt-2 w-56 bg-white border border-gray-200 rounded-lg shadow-lg">
            <div class="px-4 py-3 border-b">
              <p id="displayName" class="font-semibold text-gray-800">User</p>
              <p id="displayEmail" class="text-sm text-gray-500">email@domain.com</p>

            </div>
            <ul class="py-2 text-sm text-gray-700">
              <li><a href="{% url 'profile' %}" class="block px-4 py-2 hover:bg-gray-100">View Profile</a></li>
              <li><a href="#" class="block px-4 py-2 hover:bg-gray-100">See Plans</a></li>
              <li><a href="#" class="block px-4 py-2 hover:bg-gray-100">Help</a></li>
              <li><a href="#" class="block px-4 py-2 hover:bg-gray-100">Language</a></li>
              <li><a href="#" class="block px-4 py-2 hover:bg-gray-100">Privacy</a></li>
              <li><a href="#" class="block px-4 py-2 hover:bg-gray-100">Data Policy</a></li>
            </ul>
            <div class="border-t">
              <a href="{% url 'login' %}" class="block px-4 py-2 text-sm text-red-600 hover:bg-gray-100">Sign Out</a>
            </div>
          </div>
          </div>

            <!-- Logout Icon -->
            <a href="{% url 'login' %}" class="group relative">
              <svg class="w-6 h-6 text-gray-600 hover:text-red-600 transition" fill="none" stroke="currentColor" stroke-width="2"
                viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round"
                  d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a2 2 0 01-2 2H7a2 2 0 01-2-2V7a2 2 0 012-2h4a2 2 0 012 2v1" />
              </svg>
            </a>
          </div>
        </header>

      <!-- Main Content -->
      <main class="flex-1 px-6 md:px-10 py-8">

        <div class="flex gap-8 items-start">
          <!-- ============ Left Profile Column (independent) ============ -->
          <section class="w-full md:w-[380px] lg:w-[400px] shrink-0">
            <!-- sticky keeps it independent of right column height -->
            <div class="sticky top-24">
              <div class="bg-white rounded-2xl shadow-card p-6 flex flex-col text-center">

                <!-- Avatar + Upload -->
                <div class="relative mx-auto">
<img id="profilePic"
     src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='160' height='160'><rect width='100%' height='100%' fill='%23e5e7eb'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' fill='%239ca3af' font-family='Inter' font-size='14'>Upload</text></svg>"
     class="w-36 h-36 rounded-full object-cover shadow-soft"
     alt="Profile Picture">
                  <button class="absolute bottom-1 right-1 p-2 bg-ur-blue text-white rounded-full shadow hover:bg-ur.blue700 transition"
                          title="Upload picture"
                          onclick="document.getElementById('uploadPic').click()">
<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
  <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v6m3-3H9m12 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
</svg>
                  </button>
                  <input id="uploadPic" type="file" accept="image/*" class="hidden" onchange="previewProfilePic(event)">
                </div>

                <!-- Name / Title / Quote (disabled until edit) -->
                <input id="inputName" class="mt-4 w-full border rounded-lg p-2.5 text-center font-semibold" placeholder="Your Name" disabled>
                <input id="inputTitle" class="-mt-1 w-full border rounded-lg p-2 text-center text-gray-600" placeholder="Your Role / Title" disabled>
                <input id="inputQuote" class="mt-3 w-full border rounded-lg p-2 text-center italic" placeholder="‚ÄúAdd a short tagline or quote.‚Äù" disabled>

                <!-- Education mini list (now supports multiple) -->
                <div class="mt-6 w-full text-left border-t pt-4">
                  <div class="flex items-center justify-between">
                    <h4 class="text-sm font-semibold text-gray-500 uppercase tracking-wide">Education</h4>
                    <button id="btnAddEduMini" class="text-blue-600 text-sm hover:underline is-disabled" onclick="openEducationMiniModal()">+ Add</button>
                  </div>
                  <div id="eduMiniList" class="mt-3 space-y-3">
                    <!-- items injected -->
                  </div>
                </div>

                <!-- Social links (inputs only in edit mode) -->
                <div class="mt-5 text-left">
                  <h4 class="text-sm font-semibold text-gray-500 uppercase tracking-wide">Links</h4>
                  <div class="mt-2 grid grid-cols-1 gap-2">
                    <div class="flex items-center gap-3">
                      <div class="w-9 h-9 rounded-full grid place-items-center bg-gray-100 text-[#0a66c2]">
                        <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor"><path d="M4.98 3.5C4.98 4.88 3.88 6 2.5 6S0 4.88 0 3.5 1.12 1 2.5 1 4.98 2.12 4.98 3.5zM0 8.98h5V24H0V8.98zm7.5 0H12v2.05h.06c.63-1.2 2.17-2.47 4.47-2.47C21.4 8.56 24 11 24 15.24V24h-5v-7.6c0-1.82-.03-4.17-2.54-4.17-2.54 0-2.93 1.98-2.93 4.03V24H8V8.98z"/></svg>
                      </div>
                      <input id="linkLinkedIn" class="flex-1 border rounded-lg p-2" placeholder="https://linkedin.com/in/username" disabled>
                    </div>
                    <div class="flex items-center gap-3">
                      <div class="w-9 h-9 rounded-full grid place-items-center bg-gray-100 text-gray-900">
                        <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor"><path fill-rule="evenodd" d="M12 2a10 10 0 00-3.162 19.49c.5.092.682-.217.682-.482 0-.237-.009-.868-.013-1.703-2.776.603-3.363-1.34-3.363-1.34-.454-1.154-1.11-1.462-1.11-1.462-.909-.622.069-.61.069-.61 1.004.071 1.531 1.032 1.531 1.032.892 1.529 2.341 1.087 2.91.832.092-.647.35-1.087.636-1.338-2.218-.253-4.553-1.109-4.553-4.943 0-1.091.39-1.985 1.029-2.684-.103-.254-.446-1.273.098-2.652 0 0 .84-.269 2.75 1.026A9.563 9.563 0 0112 6.844a9.55 9.55 0 012.504.337c1.909-1.295 2.748-1.026 2.748-1.026.546 1.379.203 2.398.1 2.652.64.699 1.028 1.593 1.028 2.684 0 3.842-2.338 4.687-4.565 4.936.36.31.679.921.679 1.856 0 1.34-.012 2.421-.012 2.751 0 .267.18.577.688.479A10 10 0 0012 2z" clip-rule="evenodd"/></svg>
                      </div>
                      <input id="linkGitHub" class="flex-1 border rounded-lg p-2" placeholder="https://github.com/username" disabled>
                    </div>
                    <div class="flex items-center gap-3">
                      <div class="w-9 h-9 rounded-full grid place-items-center bg-gray-100 text-pink-600">
                        <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2a10 10 0 100 20 10 10 0 000-20zm4.83 6h-3.46a15.2 15.2 0 00-.94-3.16A8.01 8.01 0 0116.83 8zM12 4.1c.46.8.86 1.86 1.16 2.9H10.84c.3-1.04.7-2.1 1.16-2.9zM8.57 8a13.7 13.7 0 01.94-3.16A8.01 8.01 0 007.17 8h1.4zM6.1 10a14.2 14.2 0 010 4H4.1a8.02 8.02 0 010-4h2zm.07 6h1.4a13.7 13.7 0 01-.94 3.16A8.01 8.01 0 016.17 16zM12 19.9c-.46-.8-.86-1.86-1.16-2.9h2.32c-.3 1.04-.7 2.1-1.16 2.9zm3.43-3.9h1.4a8.01 8.01 0 01-2.34 3.16c.38-.97.7-2.05.94-3.16zM17.9 10a14.2 14.2 0 010 4h2a8.02 8.02 0 000-4h-2zm-1.07-2a13.7 13.7 0 01-.94-3.16A8.01 8.01 0 0117.83 8h-1.4zM8.57 16H7.17a8.01 8.01 0 002.34 3.16A13.7 13.7 0 018.57 16zM10.84 10h2.32a12.7 12.7 0 010 4h-2.32a12.7 12.7 0 010-4zM6.17 8h1.4a13.7 13.7 0 00-.94-3.16A8.01 8.01 0 006.17 8zM15.43 8h1.4a8.01 8.01 0 00-2.34-3.16c.38.97.7 2.05.94 3.16z"/></svg>
                      </div>
                      <input id="linkOther" class="flex-1 border rounded-lg p-2" placeholder="https://your.site/" disabled>
                    </div>
                  </div>
                </div>

                <!-- Edit Profile Button at bottom -->
                <div class="mt-6"></div>
                <button id="editToggle" class="mt-auto w-full py-2.5 text-sm rounded-lg shadow-soft bg-ur-blue text-white hover:bg-ur.blue700 transition"
                        onclick="toggleEditMode()">Edit Profile</button>
              </div>
            </div>
          </section>

          <!-- ============ Right Cards Column ============ -->
          <div class="flex-1 space-y-8">
            <!-- About -->
            <section class="bg-white rounded-2xl shadow-card p-6">
              <div class="flex items-center justify-between">
                <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wide">About</h3>
                <button id="btnEditAbout" class="text-blue-600 text-sm hover:underline is-disabled" onclick="openEditAbout()">‚úé Edit About</button>
              </div>
              <textarea id="aboutArea" rows="5" class="w-full mt-2 border rounded-lg p-3 focus:ring-1 focus:ring-ur-blue" placeholder="Add a short summary..." disabled></textarea>
            </section>

            <!-- Skills -->
            <section class="bg-white rounded-2xl shadow-card p-6">
              <h3 class="text-sm font-semibold text-gray-500 uppercase mb-3">Skills</h3>
              <div id="skillsContainer" class="flex flex-wrap gap-2">
                <span class="text-gray-400 text-sm italic">No skills added yet.</span>
              </div>
              <button id="btnAddSkill" onclick="openAddSkillModal()" class="mt-3 text-blue-600 text-sm hover:underline is-disabled">+ Add Skill</button>
            </section>

            <!-- Experience -->
            <section class="bg-white rounded-2xl shadow-card p-6">
              <h3 class="text-sm font-semibold text-gray-500 uppercase mb-3">Professional Experience</h3>
              <div id="experienceContainer" class="space-y-4">
                <p class="text-gray-400 text-sm italic">No experience added yet.</p>
              </div>
              <button id="btnAddExp" onclick="openAddExperienceModal()" class="mt-3 text-blue-600 text-sm hover:underline is-disabled">+ Add New Experience</button>
            </section>

            <!-- Projects -->
            <section class="bg-white rounded-2xl shadow-card p-6">
              <h3 class="text-sm font-semibold text-gray-500 uppercase mb-3">Personal Projects</h3>
              <div id="projectsContainer" class="grid md:grid-cols-2 gap-4">
                <p class="text-gray-400 text-sm italic">No projects added yet.</p>
              </div>
              <button id="btnAddProj" onclick="openAddProjectModal()" class="mt-3 text-blue-600 text-sm hover:underline is-disabled">+ Add New Project</button>
            </section>
          </div>
        </div>
      </main>
    </div>
  </div>

  <!-- ===== Sticky Save Bar ===== -->
  <div id="saveBar" class="hidden fixed bottom-6 right-8 z-50">
    <div class="bg-white shadow-card rounded-xl px-3 py-2 flex items-center gap-3 ring-1 ring-gray-200">
      <button class="px-4 py-2 rounded-md bg-gray-200 hover:bg-gray-300 text-sm" onclick="cancelEdit()">Cancel</button>
      <button class="px-4 py-2 rounded-md bg-ur-blue hover:bg-ur.blue700 text-white text-sm" onclick="saveAll()">üíæ Save Changes</button>
    </div>
  </div>

  <!-- ===== Modals ===== -->

  <!-- About Modal (kept for parity; we also allow inline textarea in edit mode) -->
  <div id="aboutModal" class="hidden fixed inset-0 z-50 bg-black/50 backdrop-blur-sm grid place-items-center">
    <div class="bg-white w-full max-w-2xl rounded-2xl shadow-card p-6">
      <h3 class="text-lg font-semibold">Edit About</h3>
      <textarea id="aboutInput" rows="6" class="mt-3 w-full border rounded-lg p-3 focus:ring-1 focus:ring-ur-blue" placeholder="Write about yourself..."></textarea>
      <div class="mt-4 flex justify-end gap-3">
        <button class="px-4 py-2 rounded-md bg-gray-200 hover:bg-gray-300" onclick="closeModal('aboutModal')">Cancel</button>
        <button class="px-4 py-2 rounded-md bg-ur-blue text-white hover:bg-ur.blue700" onclick="applyAboutFromModal()">Apply</button>
      </div>
    </div>
  </div>

  <!-- Add Skill Modal -->
  <div id="skillModal" class="hidden fixed inset-0 z-50 bg-black/50 backdrop-blur-sm grid place-items-center">
    <div class="bg-white w-full max-w-md rounded-2xl shadow-card p-6">
      <h3 class="text-lg font-semibold">Add Skill</h3>
      <input id="skillInput" type="text" class="mt-3 w-full border rounded-lg p-2.5 focus:ring-1 focus:ring-ur-blue" placeholder="e.g., Django, React, GCP">
      <div class="mt-4 flex justify-end gap-3">
        <button class="px-4 py-2 rounded-md bg-gray-200 hover:bg-gray-300" onclick="closeModal('skillModal')">Cancel</button>
        <button class="px-4 py-2 rounded-md bg-ur-blue text-white hover:bg-ur.blue700" onclick="addSkill()">Add</button>
      </div>
    </div>
  </div>

  <!-- Add Experience Modal -->
  <div id="expModal" class="hidden fixed inset-0 z-50 bg-black/50 backdrop-blur-sm grid place-items-center">
    <div class="bg-white w-full max-w-2xl rounded-2xl shadow-card p-6">
      <h3 class="text-lg font-semibold">Add Experience</h3>
      <div class="grid md:grid-cols-2 gap-3 mt-3">
        <input id="expRole" class="border rounded-lg p-2.5" placeholder="Role / Designation (e.g., Data Analyst)">
        <input id="expCompany" class="border rounded-lg p-2.5" placeholder="Company (e.g., TCS)">
        <input id="expDuration" class="border rounded-lg p-2.5 md:col-span-2" placeholder="Duration (e.g., Jan 2025 ‚Äì Present)">
        <textarea id="expDesc" rows="4" class="border rounded-lg p-2.5 md:col-span-2" placeholder="What did you do?"></textarea>
      </div>
      <div class="mt-4 flex justify-end gap-3">
        <button class="px-4 py-2 rounded-md bg-gray-200 hover:bg-gray-300" onclick="closeModal('expModal')">Cancel</button>
        <button class="px-4 py-2 rounded-md bg-ur-blue text-white hover:bg-ur.blue700" onclick="addExperience()">Add</button>
      </div>
    </div>
  </div>

  <!-- Add Project Modal -->
  <div id="projModal" class="hidden fixed inset-0 z-50 bg-black/50 backdrop-blur-sm grid place-items-center">
    <div class="bg-white w-full max-w-2xl rounded-2xl shadow-card p-6">
      <h3 class="text-lg font-semibold">Add Project</h3>
      <div class="grid md:grid-cols-2 gap-3 mt-3">
        <input id="projName" class="border rounded-lg p-2.5" placeholder="Project Name">
        <input id="projLink" class="border rounded-lg p-2.5" placeholder="Link (https://)">
        <textarea id="projDesc" rows="4" class="border rounded-lg p-2.5 md:col-span-2" placeholder="Small brief..."></textarea>
      </div>
      <div class="mt-4 flex justify-end gap-3">
        <button class="px-4 py-2 rounded-md bg-gray-200 hover:bg-gray-300" onclick="closeModal('projModal')">Cancel</button>
        <button class="px-4 py-2 rounded-md bg-ur-blue text-white hover:bg-ur.blue700" onclick="addProject()">Add</button>
      </div>
    </div>
  </div>

  <!-- Tiny Education Add Modal (list on left) -->
  <div id="eduMiniModal" class="hidden fixed inset-0 z-50 bg-black/50 backdrop-blur-sm grid place-items-center">
    <div class="bg-white w-full max-w-xl rounded-2xl shadow-card p-6">
      <h3 class="text-lg font-semibold">Education (Summary)</h3>
      <div class="grid md:grid-cols-2 gap-3 mt-3">
        <input id="miniSchool" class="border rounded-lg p-2.5" placeholder="School / University">
        <input id="miniField" class="border rounded-lg p-2.5" placeholder="Field of study">
        <input id="miniAch" class="border rounded-lg p-2.5 md:col-span-2" placeholder="Achievements / Highlights">
      </div>
      <div class="mt-4 flex justify-end gap-3">
        <button class="px-4 py-2 rounded-md bg-gray-200 hover:bg-gray-300" onclick="closeModal('eduMiniModal')">Cancel</button>
        <button class="px-4 py-2 rounded-md bg-ur-blue text-white hover:bg-ur.blue700" onclick="addMiniEducation()">Add</button>
      </div>
    </div>
  </div>

  <!-- Earnings Modal -->
      <div id="earningsModal"
         class="hidden fixed inset-0 bg-black/40 backdrop-blur-sm flex items-center justify-center z-50">
         <div class="bg-white rounded-2xl shadow-2xl p-8 text-center max-w-md w-full relative">
            <div class="absolute -top-6 left-1/2 -translate-x-1/2 animate-bounce">üí∏</div>
            <h2 class="text-2xl font-bold text-gray-800 mt-6">Earnings Launching Soon!</h2>
            <p class="mt-3 text-gray-600">
               We truly appreciate your contributions üíô<br>
               The Referrer Rewards system is under development.<br>
               Stay tuned ‚Äî your efforts will soon start paying off!
            </p>
            <div class="mt-6">
               <button disabled
                  class="px-6 py-2 rounded-lg bg-gradient-to-r from-blue-600 to-blue-500 text-white font-semibold cursor-not-allowed shadow-md">
               Coming Soon üöÄ
               </button>
            </div>
            <button onclick="closeEarningsModal()"
               class="absolute top-3 right-4 text-gray-400 hover:text-gray-700 text-2xl leading-none">&times;</button>
         </div>
      </div>


  <script>
// ‚úÖ Explicitly bind modal functions to window so inline onclicks work
window.addSkill = typeof addSkill !== 'undefined' ? addSkill : () => toast('AddSkill not loaded');
window.addExperience = typeof addExperience !== 'undefined' ? addExperience : () => toast('AddExperience not loaded');
window.addProject = typeof addProject !== 'undefined' ? addProject : () => toast('AddProject not loaded');
window.addMiniEducation = typeof addMiniEducation !== 'undefined' ? addMiniEducation : () => toast('AddMiniEducation not loaded');
window.closeModal = typeof closeModal !== 'undefined' ? closeModal : () => {};
</script>


<script>
/* ===============================================================
   UDYOG REFER ‚Äî PROFILE SCRIPT (FINAL REFINED VERSION)
   =============================================================== */

/* ----- GLOBAL HELPERS ----- */
const $ = (id) => document.getElementById(id);
const API_URL = "/api/profile/";
const REFRESH_URL = "/api/token/refresh/";

function toast(msg) {
  const el = document.createElement("div");
  el.className =
    "fixed bottom-6 left-1/2 -translate-x-1/2 z-50 bg-gray-900 text-white px-4 py-2 rounded-lg shadow";
  el.textContent = msg;
  document.body.appendChild(el);
  setTimeout(() => el.remove(), 1500);
}

/* ----- JWT + TOKEN HELPERS ----- */
/* ----- JWT + TOKEN HELPERS ----- */
const NO_TOKEN_REDIRECT = "/no_token";   // üîÅ change path if needed

function getAccessToken() {
  return (
    localStorage.getItem("access_token") ||
    localStorage.getItem("access") ||
    localStorage.getItem("token")
  );
}

function getRefreshToken() {
  return (
    localStorage.getItem("refresh_token") ||
    localStorage.getItem("refresh")
  );
}

async function ensureAccessToken() {
  let t = getAccessToken();
  if (t) return t;

  const r = getRefreshToken();
  if (!r) {
    // ‚ö†Ô∏è no refresh token ‚Äî redirect immediately
    window.location.href = NO_TOKEN_REDIRECT;
    throw new Error("No refresh token");
  }

  try {
    const res = await fetch(REFRESH_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ refresh: r }),
    });

    if (!res.ok) {
      // üî• refresh request failed ‚Äî clear tokens & redirect
      localStorage.removeItem("access_token");
      localStorage.removeItem("refresh_token");
      window.location.href = NO_TOKEN_REDIRECT;
      throw new Error("Token refresh failed");
    }

    const data = await res.json();
    if (data.access) {
      localStorage.setItem("access_token", data.access);
      return data.access;
    } else {
      // üîÅ got no access field ‚Äî clear & redirect
      localStorage.removeItem("access_token");
      localStorage.removeItem("refresh_token");
      window.location.href = NO_TOKEN_REDIRECT;
      throw new Error("Access missing in response");
    }
  } catch (err) {
    console.error("Token refresh error:", err);
    localStorage.removeItem("access_token");
    localStorage.removeItem("refresh_token");
    window.location.href = NO_TOKEN_REDIRECT;
    throw err;
  }
}


async function loadProfileFromAPI() {
  try {
    const token = await ensureAccessToken();
    if (!token) throw new Error("No JWT available");

    const res = await fetch(API_URL, {
      headers: { Authorization: `Bearer ${token}` },
    });

    // üî• If 401, redirect immediately
    if (res.status === 401) {
      localStorage.removeItem("access_token");
      localStorage.removeItem("refresh_token");
      window.location.href = "/no_token";
      return;
    }

    if (!res.ok) throw new Error("Failed to fetch profile");

    const data = await res.json();
    state.name = data.name || "";
    state.title = data.title || "";
    state.quote = data.quote || "";
    state.about = data.about || "";
    state.links.linkedin = data.linkedin || "";
    state.links.github = data.github || "";
    state.links.other = data.other_link || "";
    state.skills = data.skills || [];
    state.experiences = data.experiences || [];
    state.projects = data.projects || [];
    state.educationsMini = data.educations || [];

    renderAll();
  } catch (error) {
    console.error("Profile load error:", error);
    toast("‚ö†Ô∏è Unable to load profile");

    // üö® catch token_not_valid here too
    if (
      error.message.includes("token") ||
      error.message.includes("JWT") ||
      error.message.includes("401")
    ) {
      localStorage.removeItem("access_token");
      localStorage.removeItem("refresh_token");
      window.location.href = "/no_token";
    }
  }
}


/* ----- NETWORK HELPERS ----- */
async function apiGet() {
  const t = await ensureAccessToken();
  if (!t) throw new Error("No token");
  const res = await fetch(API_URL, { headers: { Authorization: `Bearer ${t}` } });
  if (!res.ok) throw new Error(await res.text());
  return res.json();
}
async function apiPut(payload) {
  const t = await ensureAccessToken();
  if (!t) throw new Error("No token");
  const res = await fetch(API_URL, {
    method: "PATCH",
    headers: {
      "Content-Type": "application/json",
      Authorization: `Bearer ${t}`,
    },
    body: JSON.stringify(payload),
  });
  if (!res.ok) throw new Error(await res.text());
  return res.json();
}

/* ----- STATE ----- */
window.state = {
  name: "",
  title: "",
  quote: "",
  about: "",
  linkedin: "",
  github: "",
  other_link: "",
  profile_pic: "",
  skills: [],
  experiences: [],
  projects: [],
  educations: [],
};

/* ----- DOM RENDERING ----- */
function renderBasics(d) {
  $("inputName").value = d.name || "";
  $("inputTitle").value = d.title || "";
  $("inputQuote").value = d.quote || "";
  $("aboutArea").value = d.about || "";
  $("linkLinkedIn").value = d.linkedin || "";
  $("linkGitHub").value = d.github || "";
  $("linkOther").value = d.other_link || "";
  if (d.profile_pic) $("profilePic").src = d.profile_pic;
}
function renderSkills(list) {
  const c = $("skillsContainer");
  c.innerHTML = "";
  if (!list?.length) {
    c.innerHTML = `<span class="text-gray-400 text-sm italic">No skills added yet.</span>`;
    return;
  }
  list.forEach((s) => {
    const chip = document.createElement("span");
    chip.className =
      "px-2 py-1 bg-blue-100 text-blue-700 rounded-full text-xs";
    chip.textContent = s;
    c.appendChild(chip);
  });
}
function renderExperiences(list) {
  const c = $("experienceContainer");
  c.innerHTML = "";
  if (!list?.length) {
    c.innerHTML = `<p class="text-gray-400 text-sm italic">No experience added yet.</p>`;
    return;
  }
  list.forEach((e) => {
    const div = document.createElement("div");
    div.className = "border border-gray-200 rounded-lg p-3";
    div.innerHTML = `
      <h4 class="font-medium">${e.role_name || "Role"} ‚Äî ${e.company || "Company"}</h4>
      <p class="text-sm text-gray-500">${e.duration || ""}</p>
      <p class="text-sm text-gray-700">${e.description || ""}</p>`;
    c.appendChild(div);
  });
}

function renderProjects(list) {
  const c = $("projectsContainer");
  c.innerHTML = "";
  if (!list?.length) {
    c.innerHTML = `<p class="text-gray-400 text-sm italic">No projects added yet.</p>`;
    return;
  }
  list.forEach((p) => {
    const card = document.createElement("div");
    card.className = "p-3 border border-gray-200 rounded-lg hover:border-ur-blue transition";
    card.innerHTML = `
      <h4 class="font-medium text-gray-900">${p.name || "Project"}</h4>
      <p class="text-sm text-gray-700 mt-1">${p.brief || ""}</p>
      ${p.link ? `<a href="${p.link}" target="_blank" class="text-blue-600 hover:underline text-sm">View Project ‚Üí</a>` : ""}`;
    c.appendChild(card);
  });
}

function renderEduMini(list) {
  const c = $("eduMiniList");
  c.innerHTML = "";
  if (!list?.length) {
    c.innerHTML = `<p class="text-gray-400 text-sm italic">No education added yet.</p>`;
    return;
  }
  list.forEach((ed) => {
    const div = document.createElement("div");
    div.className = "flex items-start gap-3";
    div.innerHTML = `
  <div class="mt-1 text-ur-blue">
    <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
      <path d="M12 3l9 4.5-9 4.5L3 7.5 12 3z"></path>
      <path d="M21 14l-9 4.5L3 14v-4l9 4.5 9-4.5v4z"></path>
    </svg>
  </div>
  <div class="flex-1">
    <p class="font-medium">${ed.school || "School / University"}</p>
    <p class="text-sm text-gray-500">${ed.field || ""}</p>
    <p class="text-xs text-gray-400 italic">${ed.achievements || ""}</p>
  </div>`;

    c.appendChild(div);
  });
}
function renderAll(d) {
  renderBasics(d);
  renderSkills(d.skills);
  renderExperiences(d.experiences);
  renderProjects(d.projects);
  renderEduMini(d.educations);
}

/* ----- LOAD PROFILE ----- */
async function loadProfile() {
  try {
    const d = await apiGet();
    d.skills = Array.isArray(d.skills)
      ? d.skills
      : d.skills
      ? String(d.skills).split(",").map((x) => x.trim())
      : [];
    d.experiences = Array.isArray(d.experiences) ? d.experiences : [];
    d.projects = Array.isArray(d.projects) ? d.projects : [];
    d.educations = Array.isArray(d.educations) ? d.educations : [];
    window.state = d;
    renderAll(d);
    toast("‚úÖ Profile loaded");
  } catch (e) {
    console.error(e);
    toast("‚ö†Ô∏è Unable to load profile");
  }
}
document.addEventListener("DOMContentLoaded", loadProfile);

/* ----- EDIT / SAVE LOGIC ----- */
let editActive = false;
let snapshot = null;

function toggleEditMode() {
  const ids = [
    "inputName",
    "inputTitle",
    "inputQuote",
    "aboutArea",
    "linkLinkedIn",
    "linkGitHub",
    "linkOther",
  ];
  const editBtn = $("editToggle"),
    saveBar = $("saveBar");

  if (!editActive) {
    editActive = true;
    snapshot = ids.reduce((a, id) => ((a[id] = $(id).value), a), {});
    ids.forEach((id) => ($(id).disabled = false));
    document
      .querySelectorAll(
        "#btnAddSkill,#btnAddExp,#btnAddProj,#btnAddEduMini,#btnEditAbout"
      )
      .forEach((el) => el.classList.remove("is-disabled"));
    editBtn.textContent = "Cancel Edit";
    saveBar.classList.remove("hidden");
    toast("‚úèÔ∏è Edit mode enabled");
  } else {
    editActive = false;
    ids.forEach((id) => ($(id).disabled = true));
    Object.entries(snapshot).forEach(([id, val]) => ($(id).value = val));
    document
      .querySelectorAll(
        "#btnAddSkill,#btnAddExp,#btnAddProj,#btnAddEduMini,#btnEditAbout"
      )
      .forEach((el) => el.classList.add("is-disabled"));
    editBtn.textContent = "Edit Profile";
    saveBar.classList.add("hidden");
    toast("‚ùå Changes discarded");
  }
}
async function saveAll() {
  const payload = {
    name: $("inputName").value.trim(),
    title: $("inputTitle").value.trim(),
    quote: $("inputQuote").value.trim(),
    about: $("aboutArea").value.trim(),
    linkedin: $("linkLinkedIn").value.trim(),
    github: $("linkGitHub").value.trim(),
    other_link: $("linkOther").value.trim(),
    experiences: window.state.experiences || [],     // ‚úÖ added
  projects: window.state.projects || [],           // ‚úÖ added
  educations: window.state.educationsMini || [],   // ‚úÖ added

  };
  try {
    const updated = await apiPatch(payload);

    window.state = { ...window.state, ...updated };
    renderAll(window.state);
    $("saveBar").classList.add("hidden");
    $("editToggle").textContent = "Edit Profile";
    editActive = false;
    document
      .querySelectorAll("input, textarea")
      .forEach((el) => (el.disabled = true));
    document
      .querySelectorAll(
        "#btnAddSkill,#btnAddExp,#btnAddProj,#btnAddEduMini,#btnEditAbout"
      )
      .forEach((el) => el.classList.add("is-disabled"));
    toast("‚úÖ Profile updated");
  } catch (e) {
    console.error(e);
    toast("‚ö†Ô∏è Error saving profile");
  }
}

/* ----- MODAL CONTROLS ----- */
function openAddSkillModal() {
  if (!editActive) return toast("Enable edit mode first");
  $("skillModal").classList.remove("hidden");
}
function openAddExperienceModal() {
  if (!editActive) return toast("Enable edit mode first");
  $("expModal").classList.remove("hidden");
}
function openAddProjectModal() {
  if (!editActive) return toast("Enable edit mode first");
  $("projModal").classList.remove("hidden");
}
function openEducationMiniModal() {
  if (!editActive) return toast("Enable edit mode first");
  $("eduMiniModal").classList.remove("hidden");
}
function closeModal(id) {
  $(id).classList.add("hidden");
}
document.addEventListener("keydown", (e) => {
  if (e.key === "Escape")
    document
      .querySelectorAll(".fixed.inset-0.grid.place-items-center")
      .forEach((m) => m.classList.add("hidden"));
});

/* ----- APPEND TO PROFILE SAFELY ----- */
async function appendAndPersist(field, newItem) {
  try {
    const fresh = await apiGet();
    const next = { ...fresh };

    // Normalize arrays
    next.skills      = Array.isArray(next.skills) ? [...next.skills] : [];
    next.experiences = Array.isArray(next.experiences) ? [...next.experiences] : [];
    next.projects    = Array.isArray(next.projects) ? [...next.projects] : [];
    next.educations  = Array.isArray(next.educations) ? [...next.educations] : [];

    // Strict content checker
    const hasContent = (obj) =>
      obj && Object.values(obj).some(v => typeof v === "string" && v.trim().length > 0);

    // ---- Update the changed field only ----
    if (field === "skills") {
      const val = String(newItem ?? "").trim();
      if (val && !next.skills.includes(val)) next.skills.push(val);
    } else if (["projects", "experiences", "educations"].includes(field)) {
      next[field] = next[field].filter(hasContent);
      if (hasContent(newItem)) next[field].push(newItem);
    }

    // ‚úÖ Build the full profile payload (includes all arrays)
    const payload = {
      name: next.name || "",
      title: next.title || "",
      quote: next.quote || "",
      about: next.about || "",
      linkedin: next.linkedin || "",
      github: next.github || "",
      other_link: next.other_link || "",
      skills: next.skills.map(s => s),
      experiences: next.experiences.map(e => ({
        role_name: (e.role_name ?? "").trim(),
        company:   (e.company ?? "").trim(),
        duration:  (e.duration ?? "").trim(),
        description: (e.description ?? "").trim(),
      })),
      projects: next.projects.map(p => ({
        name: (p.name ?? "").trim(),
        link: (p.link ?? "").trim(),
        brief: (p.brief ?? "").trim(),
      })),
      educations: next.educations.map(ed => ({
        school: (ed.school ?? "").trim(),
        field:  (ed.field ?? "").trim(),
        achievements: (ed.achievements ?? "").trim(),
      })),
    };

    // Persist the full payload
    const updated = await apiPatch(payload);
    window.state = { ...window.state, ...updated };
    renderAll(window.state);
    toast("‚úÖ Changes saved successfully");
    return true;

  } catch (err) {
    console.error("appendAndPersist error:", err);
    toast("‚ö†Ô∏è Update failed");
    return false;
  }
}

async function apiPatch(payload) {
  const token = await ensureAccessToken();
  const res = await fetch(API_URL, {
    method: "PATCH",
    headers: {
      "Content-Type": "application/json",
      Authorization: `Bearer ${token}`,
    },
    body: JSON.stringify(payload),
  });

  if (res.status === 401) {
  localStorage.removeItem("access_token");
  localStorage.removeItem("refresh_token");
  window.location.href = "/no_token";
  return;
}


  if (!res.ok) {
    let msg = `PATCH failed (${res.status})`;
    try {
      const txt = await res.text();
      msg += `: ${txt}`;
      console.error("PATCH error body:", txt);
    } catch (_) {}
    throw new Error(msg);
  }
  return await res.json();
}


/* ----- ADD MODAL ACTIONS ----- */
async function addSkill() {
  const v = $("skillInput").value.trim();
  if (!v) return toast("Enter a skill");
  const ok = await appendAndPersist("skills", v);
  if (ok) {
    $("skillInput").value = "";
    closeModal("skillModal");
    toast("‚úÖ Skill added");
  }
}
async function addExperience() {
  const e = {
    role_name: $("expRole").value.trim(),     // ‚úÖ fixed
    company: $("expCompany").value.trim(),
    duration: $("expDuration").value.trim(),
    description: $("expDesc").value.trim(),   // ‚úÖ fixed
  };
  if (!e.role_name && !e.company) return toast("Add role or company");
  const ok = await appendAndPersist("experiences", e);
  if (ok) {
    closeModal("expModal");
    $("expRole").value =
      $("expCompany").value =
      $("expDuration").value =
      $("expDesc").value = "";
    toast("‚úÖ Experience added");
  }
}

async function addProject() {
  const p = {
    name: $("projName").value.trim(),
    link: $("projLink").value.trim(),
    brief: $("projDesc").value.trim(),

  };
  if (!p.name) return toast("Project name required");
  const ok = await appendAndPersist("projects", p);
  if (ok) {
    closeModal("projModal");
    $("projName").value = $("projLink").value = $("projDesc").value = "";
    toast("‚úÖ Project added");
  }
}
async function addMiniEducation() {
  const ed = {
    school: $("miniSchool").value.trim(),
    field: $("miniField").value.trim(),
    achievements: $("miniAch").value.trim(),

  };
  if (!ed.school) return toast("Enter school");
  const ok = await appendAndPersist("educations", ed);
  if (ok) {
    closeModal("eduMiniModal");
    $("miniSchool").value = $("miniField").value = $("miniAch").value = "";
    toast("‚úÖ Education added");
  }
}

/* ----- EXPORT GLOBAL FUNCTIONS FOR HTML ONCLICK ----- */
window.toggleEditMode = toggleEditMode;
window.saveAll = saveAll;
window.addSkill = addSkill;
window.addExperience = addExperience;
window.addProject = addProject;
window.addMiniEducation = addMiniEducation;
window.openAddSkillModal = openAddSkillModal;
window.openAddExperienceModal = openAddExperienceModal;
window.openAddProjectModal = openAddProjectModal;
window.openEducationMiniModal = openEducationMiniModal;
window.closeModal = closeModal;
</script>

<script>
  function openPAModal() {
    const m = document.getElementById('paModal');
    m.classList.remove('hidden'); 
    m.classList.add('flex');
    document.getElementById('msgPA')?.focus();
  }

  function closePAModal() {
    const m = document.getElementById('paModal');
    m.classList.add('hidden'); 
    m.classList.remove('flex');
  }
</script>

<script>
  document.getElementById("displayName").textContent = localStorage.getItem("username");
  document.getElementById("displayEmail").textContent = localStorage.getItem("email");
</script>

<script>
  function toggleProfileModal() {
    const modal = document.getElementById('profileModal');
    modal.classList.toggle('hidden');
  }

  // Close if clicked outside
  document.addEventListener('click', (e) => {
    const modal = document.getElementById('profileModal');
    if (!modal.contains(e.target) &&
        !e.target.closest('button[onclick="toggleProfileModal()"]')) {
      modal.classList.add('hidden');
    }
  });
</script>


 <script>
         function openEarningsModal() {
           const modal = document.getElementById("earningsModal");
           modal.classList.remove("hidden");
           modal.classList.add("flex");
         }
         
         function closeEarningsModal() {
           const modal = document.getElementById("earningsModal");
           modal.classList.add("hidden");
           modal.classList.remove("flex");
         }
      </script>
</body>
</html>


