<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>UDYOG REFER</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="icon" type="image/png" href="{% static 'img/ur_logo.ico' %}">
</head>

<body class="bg-[#0d1117] min-h-screen flex items-center justify-center text-white">

  <div class="flex flex-col items-center space-y-6 text-center">
    <!-- Title -->
    <div>
      <div class="text-6xl font-extrabold text-gray-200 tracking-widest">UR</div>
      <div class="text-4xl font-semibold text-gray-200 mt-2">UDYOG REFER</div>
      <div class="text-2xl font-bold mt-10">Welcome!</div>
    </div>

    <!-- Buttons -->
    <div class="flex flex-col items-center space-y-5 w-80">

      <button
        class="w-full py-3 bg-blue-500 rounded-lg hover:bg-blue-700 font-semibold"
        onclick="setRoleAndGo('referrer', '/referer_home')">
        I can REFER
      </button>

      <button
        class="w-full py-3 bg-blue-700 rounded-lg hover:bg-blue-500 font-semibold"
        onclick="setRoleAndGo('referee', '/active_referals')">
        I want a REFERRAL
      </button>

      <!-- Logout -->
      <div class="mt-8">
        <a href="login" onclick="localStorage.clear();">
          <button class="text-sm text-red-400 hover:text-red-200 underline">Logout</button>
        </a>
      </div>
    </div>
  </div>

  <!-- MASTER SCRIPT -->
  <script>
  /* -----------------------------------------------------------
      1. CAPTURE GOOGLE CALLBACK PARAMS
  ------------------------------------------------------------*/
  const params = new URLSearchParams(window.location.search);
  const access = params.get("access");
  const refresh = params.get("refresh");
  const email = params.get("email");
  const name = params.get("name");

  /* -----------------------------------------------------------
      2. SAVE TOKENS FROM GOOGLE LOGIN
  ------------------------------------------------------------*/
  if (access && refresh) {
    console.log("✅ Tokens received:", access, refresh);
    localStorage.setItem("access_token", access);
    localStorage.setItem("refresh_token", refresh);
  }

  /* -----------------------------------------------------------
      3. SAVE BASIC USER INFO (EMAIL + NAME)
  ------------------------------------------------------------*/
  if (email) {
    localStorage.setItem("email", email);
    localStorage.setItem("username", name || email.split("@")[0]);
  }

  /* -----------------------------------------------------------
      4. ROLE SELECTION LOGIC
  ------------------------------------------------------------*/
  async function setRoleAndGo(role, nextUrl) {
    try {
      const USER_ID = localStorage.getItem("uid"); // for manual signups
      const USER_EMAIL = localStorage.getItem("email");

      if (!USER_ID && !USER_EMAIL) {
        alert("Session expired. Please log in again.");
        return (window.location.href = "/login");
      }

      const payload = USER_ID
        ? { role, user_id: parseInt(USER_ID) }
        : { role, email: USER_EMAIL };

      console.log("POST /api/set-role/ →", payload);

      const res = await fetch("/api/set-role/", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${localStorage.getItem("access_token") || ""}`,
        },
        body: JSON.stringify(payload),
      });

      const data = await res.json();

      if (!res.ok) {
        console.error("ROLE SET ERROR →", data);
        alert("Failed to set role. Check console.");
        return;
      }

      console.log("✅ ROLE SAVED →", data);

      // cleanup only UID
      localStorage.removeItem("uid");

      // navigate to server-defined page or fallback
      window.location.href = data.redirect || nextUrl;
    } catch (err) {
      console.error("❌ setRoleAndGo error:", err);
      alert("Something went wrong. Check console.");
    }
  }
  </script>
</body>
</html>
